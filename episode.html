<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WM3KEDD127"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-WM3KEDD127');
  </script>

  <meta charset="UTF-8" />
  <title>SM-TV ‚Äì Streaming</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Your main site styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Popup & video styles -->
  <style>
    body { margin: 0; padding: 0; overflow-x: hidden; }
    #episode-view { min-height: 100vh; }

    #unlockPopup {
      display: none;
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 99999;
      padding: 16px;
      background: rgba(0,0,0,0.04);
      backdrop-filter: blur(4px) saturate(130%);
      -webkit-backdrop-filter: blur(4px) saturate(130%);
      overflow-y: auto;
    }

    .popup-container { min-height: 100%; display:flex; align-items:center; justify-content:center; }
    .popup-card {
      max-width: 460px; width:100%; border-radius:24px; padding:24px 20px 20px;
      position:relative; overflow:hidden;
      background: linear-gradient(135deg, rgba(11,18,35,0.82), rgba(11,18,35,0.60));
      border:1px solid rgba(255,255,255,0.20);
      box-shadow:0 20px 50px rgba(0,0,0,0.55);
      animation: popupIn 0.30s ease-out forwards;
    }
    .popup-card::before {
      content:""; position:absolute; inset:-1px; pointer-events:none;
      background: radial-gradient(circle at 0% 0%, rgba(0,208,240,0.7), transparent 55%),
                  radial-gradient(circle at 100% 100%, rgba(255,212,0,0.7), transparent 55%);
      opacity:0.18; mix-blend-mode:screen;
    }
    @keyframes popupIn { from {opacity:0; transform:translateY(14px) scale(0.97);} to {opacity:1; transform:translateY(0) scale(1);} }

    .popup-header { text-align:center; margin-bottom:20px; position:relative; z-index:1; }
    .popup-lock-icon {
      font-size:32px; margin-bottom:10px; display:inline-flex; align-items:center; justify-content:center;
      width:52px; height:52px; border-radius:999px;
      background: radial-gradient(circle at 30% 0%, rgba(0,208,240,0.95), rgba(18,27,56,0.6));
      box-shadow: 0 0 20px rgba(0,208,240,0.9), 0 10px 24px rgba(0,0,0,0.8);
    }
    .popup-header h2 { color:#f4f7ff; font-size:23px; margin:6px 0 4px; font-weight:800; letter-spacing:0.03em; }
    .popup-header p { color: rgba(225,235,255,0.86); font-size:14px; margin:0; font-weight:500; }

    .sponsor-section {
      position:relative; z-index:1; border-radius:18px; padding:16px 15px 16px; margin-bottom:16px;
      background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(0,0,0,0.25));
      border:1px solid rgba(139,233,255,0.55);
    }
    .sponsor-section h3 {
      color:#8be9ff; font-size:14px; margin:0 0 10px; text-align:center; font-weight:700; text-transform:uppercase; letter-spacing:0.10em;
    }

    .sponsor-brand-container { display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:10px; }
    .sponsor-logo { width:44px; height:44px; border-radius:14px; object-fit:cover; border:2px solid rgba(255,212,0,0.6); box-shadow:0 6px 16px rgba(255,212,0,0.7); }
    .sponsor-brand { color:#ffd962; font-size:21px; font-weight:900; text-shadow:0 0 16px rgba(255,212,0,0.85), 0 0 32px rgba(255,180,0,0.7); }

    .unlock-message { color: rgba(235,244,255,0.90); text-align:center; margin:0 4px 14px; font-size:13px; line-height:1.6; font-weight:500; }

    .unlock-btn {
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:14px 22px; width:100%; border-radius:999px; border:none; text-decoration:none; cursor:pointer;
      font-weight:800; font-size:14px; letter-spacing:0.09em; text-transform:uppercase;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 45%, #f093fb 100%);
      color:#fff; box-shadow:0 12px 28px rgba(118,75,162,0.7), 0 0 26px rgba(240,147,251,0.8);
      text-shadow:0 2px 7px rgba(0,0,0,0.45); transition:all 0.3s ease;
    }
    .unlock-btn:hover { transform:translateY(-1.5px); filter:brightness(1.06); box-shadow:0 16px 36px rgba(118,75,162,0.9), 0 0 32px rgba(240,147,251,1); }
    .unlock-btn:active { transform:translateY(0); }

    .howto-row { display:flex; justify-content:center; margin-top:10px; gap:10px; }
    .howto-btn {
      background:none; border:1px solid rgba(143,211,255,0.18); color:#8fd3ff; padding:8px 12px; border-radius:999px;
      font-weight:700; font-size:13px; cursor:pointer; text-decoration:none; display:inline-flex; gap:8px; align-items:center;
      box-shadow:0 6px 18px rgba(11,27,42,0.6); transition:all 0.18s ease;
    }
    .howto-btn:hover { transform:translateY(-2px); box-shadow:0 10px 26px rgba(11,27,42,0.65); background:rgba(255,255,255,0.02); }

    .contact-section { position:relative; z-index:1; margin-top:14px; border-radius:18px; padding:14px 13px 14px;
      background: linear-gradient(145deg, rgba(255,255,255,0.02), rgba(0,0,0,0.28)); border:1px solid rgba(255,212,0,0.55); text-align:center; }
    .contact-section h3 { color:#ffd962; font-size:16px; margin:0 0 4px; font-weight:800; }
    .contact-section p { color: rgba(240,244,255,0.90); font-size:13px; line-height:1.55; margin:0 4px 10px; }
    .contact-btn {
      display:inline-flex; align-items:center; gap:6px; padding:9px 19px;
      background: linear-gradient(90deg, rgba(255,212,0,0.96), rgba(255,179,87,0.98));
      color:#151515; font-weight:800; font-size:13px; border-radius:999px; text-decoration:none;
      box-shadow:0 10px 24px rgba(255,212,0,0.7), 0 0 20px rgba(255,212,0,1); transition:transform .16s ease, box-shadow .16s ease;
    }
    .contact-btn:hover { transform:translateY(-1px); }

    /* Inline video block (hidden until opened) */
    .howto-video-block {
      display: none;
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      background: linear-gradient(180deg, rgba(6,12,20,0.98), rgba(10,16,28,0.98));
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
    }
    .howto-video-header {
      display:flex; align-items:center; justify-content:space-between; padding:10px 12px; gap:12px;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    .howto-video-title { color:#8fd3ff; font-weight:800; font-size:14px; }
    .howto-video-close {
      background:none; border:1px solid rgba(255,255,255,0.04); color:#fff; padding:6px 8px; border-radius:8px; cursor:pointer;
    }
    .howto-video-caption { padding:10px 12px; color:rgba(220,230,255,0.9); font-size:13px; line-height:1.45; }

    /* REPLACED video wrapper for portrait videos */
    .howto-video-wrap {
      position: relative;
      width: 100%;
      padding-bottom: 0; /* allow tall portrait video */
      height: min(80vh, 780px); /* allow tall vertical video up to 80% of viewport */
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    .howto-video-wrap iframe {
      width: auto;
      height: 100%;
      max-width: 420px; /* phone-friendly; adjust for larger screens */
      border: 0;
      display: block;
      margin: 0 auto;
    }

    /* Desktop / wide viewport fallback - use 16:9 */
    @media (min-width: 900px) {
      .howto-video-wrap {
        padding-bottom: 56.25%;
        height: auto;
      }
      .howto-video-wrap iframe {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        max-width: none;
      }
    }

    @media (max-width:520px) {
      #unlockPopup { padding:10px; }
      .popup-card { padding:22px 16px 18px; border-radius:20px; }
      .popup-header h2 { font-size:20px; }
      .sponsor-brand { font-size:18px; }
    }
  </style>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Episode logic (keeps external file if you use it) -->
  <script defer src="episode.js"></script>
</head>
<body>
  <!-- Episode Player -->
  <div id="episode-view"></div>

  <!-- Unlock Popup -->
  <div id="unlockPopup" role="dialog" aria-modal="true" aria-label="Unlock Episode Popup">
    <div class="popup-container">
      <div class="popup-card">

        <div class="popup-header">
          <div class="popup-lock-icon">üîí</div>
          <h2 id="popupTitle">Unlock Episode</h2>
          <p id="popupSubtitle">Episode <span id="episodeNumber">1</span></p>
        </div>

        <div class="sponsor-section">
          <h3>Episode Sponsored By</h3>

          <div class="sponsor-brand-container">
            <img src="sponsor.png" alt="Sponsor Logo" class="sponsor-logo" />
            <div class="sponsor-brand">FX Reall Accadmy</div>
          </div>

          <p class="unlock-message" id="unlockMessage">
            Join our sponsor channel to unlock 3 episodes for 24 hours
          </p>

          <!-- Main unlock button (original flow) -->
          <a href="https://t.me/+OKnw3z4Uq28wYzRk"
             target="_blank"
             rel="noopener noreferrer"
             class="unlock-btn"
             id="unlockBtn">
            <i class="fas fa-paper-plane"></i>
            <span id="btnText">Join Channel & Unlock</span>
          </a>

          <!-- How-to: inline video toggle (single button) -->
          <div class="howto-row">
            <button class="howto-btn" id="openHowtoInlineBtn" type="button">
              <i class="fas fa-play-circle"></i> How to Unlock? (Watch Video)
            </button>
          </div>

          <!-- Inline video block (appears beneath the buttons) -->
          <div class="howto-video-block" id="howtoVideoBlock" aria-hidden="true">
            <div class="howto-video-header">
              <div class="howto-video-title">Process of how to Unlock</div>
              <div style="display:flex;gap:8px;align-items:center;">
                <button class="howto-video-close" id="howtoFullscreenHint" title="Tap ‚§¢ to fullscreen" style="display:none;background:none;border:0;color:#8fd3ff;font-weight:700;">‚§¢</button>
                <button class="howto-video-close" id="closeHowtoInlineBtn">Close</button>
              </div>
            </div>
            <div class="howto-video-caption">Ya Video dekho ‚Äî Unlock kaisa karna ‚Äî then tap <strong>Join Channel & Unlock</strong> below.</div>
            <div class="howto-video-wrap" id="howtoVideoWrap">
              <!-- iframe injected dynamically -->
            </div>
          </div>

        </div>

        <div class="contact-section">
          <h3>Become a Sponsor</h3>
          <p>Advertise your brand here and reach thousands of active viewers every day.</p>
          <a href="https://t.me/itz_me_zain1" class="contact-btn" rel="noopener noreferrer">
            <i class="fas fa-envelope"></i>
            Contact Us
          </a>
        </div>

      </div>
    </div>
  </div>

  <!-- Unlock System + inline video handlers -->
  <script>
  (function() {
    const popup = document.getElementById('unlockPopup');
    const unlockBtn = document.getElementById('unlockBtn');
    const btnText = document.getElementById('btnText');
    const popupTitle = document.getElementById('popupTitle');
    const popupSubtitle = document.getElementById('popupSubtitle');
    const episodeNumber = document.getElementById('episodeNumber');
    const unlockMessage = document.getElementById('unlockMessage');
    const lockIcon = document.querySelector('.popup-lock-icon');

    // Inline how-to controls
    const openHowtoInlineBtn = document.getElementById('openHowtoInlineBtn');
    const howtoVideoBlock = document.getElementById('howtoVideoBlock');
    const howtoVideoWrap = document.getElementById('howtoVideoWrap');
    const closeHowtoInlineBtn = document.getElementById('closeHowtoInlineBtn');

    // Small fullscreen hint/button (we'll show the functional button instead)
    const howtoFullscreenHint = document.getElementById('howtoFullscreenHint');

    // Rumble embed URL
    const rumbleEmbedUrl = 'https://rumble.com/embed/v7018ms/?pub=4ni0h4';

    // Get episode info from URL
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('series');
    const season = urlParams.get('season');
    const ep = urlParams.get('ep');

    if (!slug || !season || !ep) {
      console.error('Missing episode parameters');
      // still show the popup in case you want to debug, but we'll stop here for safety
      // return;
    }

    if (ep) episodeNumber.textContent = ep;
    const currentEp = parseInt(ep) || 1;

    // Check if current episode is accessible via any unlock within 24 hours
    function isEpisodeAccessible(episodeNum) {
      for (let i = 0; i < 3; i++) {
        const checkEp = episodeNum - i;
        if (checkEp < 1) continue;

        const unlockKey = 'unlocked_' + slug + '_s' + season + '_e' + checkEp;
        const unlockTimeKey = unlockKey + '_time';
        const unlockTime = localStorage.getItem(unlockTimeKey);
        if (!unlockTime) continue;

        const hoursPassed = (Date.now() - parseInt(unlockTime)) / (1000 * 60 * 60);
        if (hoursPassed < 24 && localStorage.getItem(unlockKey) === 'true') {
          return true;
        } else if (hoursPassed >= 24) {
          localStorage.removeItem(unlockKey);
          localStorage.removeItem(unlockTimeKey);
        }
      }
      return false;
    }

    // Update popup message based on current episode
    function updatePopupMessage() {
      const ep1 = currentEp;
      const ep2 = currentEp + 1;
      const ep3 = currentEp + 2;
      unlockMessage.textContent = `üì∫ Unlock to watch episodes ${ep1}, ${ep2}, and ${ep3} for 24 hours`;
      popupSubtitle.textContent = `Unlock 3 episodes starting from ${ep1}`;
    }

    // Show popup if locked
    if (!isEpisodeAccessible(currentEp)) {
      updatePopupMessage();
      setTimeout(function() { popup.style.display = 'block'; }, 500);
    } else {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'episode_watch', {
          'episode': (slug||'') + '_s' + (season||'') + 'e' + (ep||''),
          'access_type': 'unlocked'
        });
      }
    }

    // Unlock click logic (keeps your double-click verify flow)
    let isProcessing = false;
    unlockBtn.addEventListener('click', function(e) {
      if (isProcessing) {
        if (btnText.innerHTML.includes('Tap to Watch')) {
          const unlockKey = 'unlocked_' + slug + '_s' + season + '_e' + currentEp;
          const unlockTimeKey = unlockKey + '_time';
          localStorage.setItem(unlockKey, 'true');
          localStorage.setItem(unlockTimeKey, Date.now().toString());
          popup.style.display = 'none';
          if (typeof gtag !== 'undefined') {
            gtag('event', 'episode_unlock_complete', {
              'episode': (slug||'') + '_s' + (season||'') + 'e' + (ep||''),
              'unlocks_count': 3
            });
          }
        }
        return;
      }

      // First click: simulate verify
      isProcessing = true;
      unlockBtn.style.opacity = '0.6';
      unlockBtn.style.pointerEvents = 'none';
      btnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
      popupTitle.textContent = 'Verifying Membership...';
      lockIcon.textContent = '‚è≥';

      if (typeof gtag !== 'undefined') {
        gtag('event', 'episode_unlock_attempt', {
          'episode': (slug||'') + '_s' + (season||'') + 'e' + (ep||'')
        });
      }

      setTimeout(function() {
        unlockBtn.style.opacity = '1';
        unlockBtn.style.pointerEvents = 'auto';
        unlockBtn.style.cursor = 'pointer';
        unlockBtn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
        unlockBtn.style.boxShadow = '0 12px 28px rgba(17,153,142,0.8), 0 0 32px rgba(56,239,125,1)';

        const ep1 = currentEp;
        const ep2 = currentEp + 1;
        const ep3 = currentEp + 2;

        btnText.innerHTML = '<i class="fas fa-check-circle"></i> Unlocked! Tap to Watch';
        popupTitle.textContent = 'Successfully Unlocked!';
        popupSubtitle.textContent = `Episodes ${ep1}-${ep3} available for 24h`;
        lockIcon.textContent = '‚úÖ';
        unlockMessage.textContent = `üéâ Episodes ${ep1}, ${ep2}, and ${ep3} are now free for 24 hours!`;

        if (typeof gtag !== 'undefined') {
          gtag('event', 'episode_unlock_verified', {
            'episode': (slug||'') + '_s' + (season||'') + 'e' + (ep||''),
            'unlocked_episodes': ep1 + ',' + ep2 + ',' + ep3
          });
        }
      }, 15000); // 15s verification
    });

    // ---------- Inline how-to handlers (portrait-friendly + fullscreen) ----------
    function openHowtoInline() {
      // inject iframe only once (destroyed when closed)
      if (!howtoVideoWrap.querySelector('iframe')) {
        const iframe = document.createElement('iframe');
        iframe.className = 'rumble';
        iframe.src = rumbleEmbedUrl;
        iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
        iframe.setAttribute('allowfullscreen', '');
        iframe.setAttribute('referrerpolicy', 'no-referrer');
        iframe.setAttribute('title', 'How to Unlock ‚Äî quick guide');
        howtoVideoWrap.appendChild(iframe);
      }

      // create functional fullscreen button (‚§¢) near header if not exists
      if (!document.getElementById('howtoFullscreenBtn')) {
        const fsBtn = document.createElement('button');
        fsBtn.id = 'howtoFullscreenBtn';
        fsBtn.className = 'howto-video-close';
        fsBtn.style.marginLeft = '8px';
        fsBtn.style.fontWeight = '800';
        fsBtn.title = 'Fullscreen';
        fsBtn.innerHTML = '‚§¢';
        // append next to Close button
        const headerRight = document.querySelector('.howto-video-header div[style]');
        if (headerRight) {
          headerRight.insertBefore(fsBtn, headerRight.firstChild);
        } else {
          document.querySelector('.howto-video-header').appendChild(fsBtn);
        }

        fsBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          const el = howtoVideoWrap;
          if (el.requestFullscreen) {
            el.requestFullscreen().catch(()=>{});
          } else if (el.webkitRequestFullscreen) {
            el.webkitRequestFullscreen();
          } else if (el.msRequestFullscreen) {
            el.msRequestFullscreen();
          }
        });
      }

      howtoVideoBlock.style.display = 'block';
      howtoVideoBlock.setAttribute('aria-hidden', 'false');

      // scroll the popup card to center so the video is visible
      setTimeout(() => {
        document.querySelector('.popup-card').scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 120);

      if (typeof gtag !== 'undefined') {
        gtag('event', 'howto_video_open_inline', {
          'episode': (slug||'') + '_s' + (season||'') + 'e' + (ep||'')
        });
      }
    }

    function closeHowtoInline() {
      // exit fullscreen if active
      try {
        if (document.fullscreenElement || document.webkitFullscreenElement) {
          if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }
      } catch (e) { /* ignore */ }

      howtoVideoWrap.innerHTML = ''; // remove iframe to stop playback
      howtoVideoBlock.style.display = 'none';
      howtoVideoBlock.setAttribute('aria-hidden', 'true');

      // remove fullscreen button if present
      const fsBtn = document.getElementById('howtoFullscreenBtn');
      if (fsBtn && fsBtn.parentNode) fsBtn.parentNode.removeChild(fsBtn);

      if (typeof gtag !== 'undefined') {
        gtag('event', 'howto_video_close_inline', {
          'episode': (slug||'') + '_s' + (season||'') + 'e' + (ep||'')
        });
      }
    }

    openHowtoInlineBtn.addEventListener('click', openHowtoInline);
    closeHowtoInlineBtn.addEventListener('click', closeHowtoInline);

    // hide video block when user presses Escape (and remove iframe)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && howtoVideoBlock.style.display === 'block') {
        closeHowtoInline();
      }
    });

    // close video if user taps outside popup-card and video is visible (optional UX)
    document.addEventListener('click', function(ev) {
      const card = document.querySelector('.popup-card');
      if (!card) return;
      if (howtoVideoBlock.style.display === 'block') {
        // if click target outside the popup-card, close video
        if (!card.contains(ev.target)) {
          closeHowtoInline();
        }
      }
    });

  })();
  </script>
</body>
</html>
